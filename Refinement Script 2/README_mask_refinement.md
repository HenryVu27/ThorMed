# Mask Refinement for SAMUS Segmentation

This repository contains tools for refining segmentation masks generated by the SAMUS model. The refinement process helps smooth choppy masks and handles multiple disconnected regions to produce cleaner, more accurate results.

## Features

- **Adaptive Thresholding**: Uses Otsu's method for optimal threshold selection
- **Small Object Removal**: Eliminates noise and small disconnected regions
- **Hole Filling**: Fills gaps within main objects
- **Morphological Operations**: Smooths contours using opening/closing operations
- **Gaussian Smoothing**: Final smoothing for cleaner edges
- **Largest Component Selection**: Keeps only the main object (useful for single-organ segmentation)
- **Batch Processing**: Efficient processing of multiple masks
- **Performance Optimized**: Fast operations suitable for real-time applications

## Quick Start

### 1. Basic Usage

Refine existing masks:
```bash
python mask_refiner.py --input_dir segmentation_masks --output_dir refined_masks
```

### 2. Integrated Inference

Run SAMUS inference with built-in refinement:
```bash
python infer_bladder_images_refined.py --data_dir bladder --output_dir refined_segmentation_masks --create_comparison
```

### 3. Single File Processing

Process a single mask:
```bash
python mask_refiner.py --single_file path/to/mask.png --output_dir refined_masks
```

## Configuration Options

### Refinement Parameters

| Parameter | Default | Description |
|-----------|---------|-------------|
| `min_object_size` | 150 | Minimum size (pixels) for objects to keep |
| `hole_fill_threshold` | 75 | Maximum hole size to fill |
| `kernel_size` | 3 | Size of morphological operations kernel |
| `gaussian_sigma` | 0.5 | Standard deviation for Gaussian smoothing |
| `preserve_largest` | True | Keep only the largest connected component |
| `adaptive_threshold` | True | Use adaptive thresholding on probability maps |

### Usage Examples

#### Conservative Refinement (preserves details)
```bash
python mask_refiner.py \
    --input_dir segmentation_masks \
    --output_dir gentle_refined \
    --min_object_size 50 \
    --hole_fill_threshold 20 \
    --kernel_size 2 \
    --gaussian_sigma 0.3
```

#### Aggressive Cleaning (removes more noise)
```bash
python mask_refiner.py \
    --input_dir segmentation_masks \
    --output_dir aggressive_refined \
    --min_object_size 300 \
    --hole_fill_threshold 150 \
    --kernel_size 5 \
    --gaussian_sigma 1.0 \
    --preserve_largest
```

## Python API Usage

### Basic Refinement

```python
from mask_refiner import MaskRefiner
from PIL import Image
import numpy as np

# Initialize refiner
refiner = MaskRefiner(
    min_object_size=150,
    hole_fill_area_threshold=75,
    morphology_kernel_size=3,
    gaussian_sigma=0.5,
    preserve_largest_component=True
)

# Refine a mask file
refined_mask = refiner.refine_mask("path/to/mask.png")

# Save result
Image.fromarray(refined_mask).save("refined_mask.png")
```

### Using with Probability Maps

```python
# If you have probability maps from your model
probability_map = model_output.sigmoid().cpu().numpy()

# Refine using probability map with adaptive thresholding
refined_mask = refiner.refine_mask(
    input_mask=None,
    probability_map=probability_map
)
```

### Batch Processing

```python
# Process all masks in a directory
refiner.batch_refine(
    input_dir="segmentation_masks",
    output_dir="refined_masks",
    suffix="_refined",
    verbose=True
)
```

## Integration with SAMUS

The `infer_bladder_images_refined.py` script shows how to integrate refinement directly into your SAMUS inference pipeline:

```python
from mask_refiner import MaskRefiner

# Initialize refiner with your preferred settings
refiner = MaskRefiner(
    min_object_size=150,
    preserve_largest_component=True
)

# In your inference loop:
probability_map = torch.sigmoid(model_output).cpu().numpy()
refined_mask = refiner.refine_mask(
    input_mask=None,
    probability_map=probability_map
)
```

## Performance Optimization

### Speed vs Quality Trade-offs

**For Maximum Speed:**
```python
fast_refiner = MaskRefiner(
    min_object_size=200,        # Higher = faster
    hole_fill_area_threshold=0, # Disable hole filling
    morphology_kernel_size=2,   # Smaller kernel
    gaussian_sigma=0,           # Disable smoothing
    preserve_largest_component=True
)
```

**For Maximum Quality:**
```python
quality_refiner = MaskRefiner(
    min_object_size=50,         # Lower = more detail preservation
    hole_fill_area_threshold=100,
    morphology_kernel_size=5,   # Larger kernel for better smoothing
    gaussian_sigma=1.0,         # More smoothing
    preserve_largest_component=True
)
```

### Typical Processing Times

On a typical CPU (Intel i7):
- Small masks (256x256): ~5-15ms per mask
- Medium masks (512x512): ~15-40ms per mask
- Large masks (1024x1024): ~50-150ms per mask

## File Structure

```
├── mask_refiner.py                 # Main refinement class
├── infer_bladder_images_refined.py # Integrated SAMUS + refinement
├── example_mask_refinement.py      # Usage examples
└── README_mask_refinement.md       # This file
```

## Workflow Steps

The refinement process follows these steps:

1. **Input Processing**: Load mask or convert probability map to binary
2. **Thresholding**: Apply fixed or adaptive threshold
3. **Small Object Removal**: Remove connected components below size threshold
4. **Hole Filling**: Fill holes within objects (with size filtering)
5. **Morphological Operations**: Apply opening then closing for smoothing
6. **Largest Component**: Optionally keep only the largest object
7. **Gaussian Smoothing**: Final edge smoothing

## Common Use Cases

### Medical Image Segmentation
```python
medical_refiner = MaskRefiner(
    min_object_size=100,
    hole_fill_area_threshold=50,
    preserve_largest_component=True  # Single organ
)
```

### Multi-Object Segmentation
```python
multi_object_refiner = MaskRefiner(
    min_object_size=50,
    preserve_largest_component=False  # Keep all objects
)
```

### Real-time Applications
```python
realtime_refiner = MaskRefiner(
    min_object_size=200,
    morphology_kernel_size=2,
    gaussian_sigma=0.3  # Light processing
)
```

## Troubleshooting

### Common Issues

1. **Masks are over-smoothed**: Reduce `gaussian_sigma` or `morphology_kernel_size`
2. **Important details are lost**: Lower `min_object_size`
3. **Processing is too slow**: Increase `min_object_size`, reduce `gaussian_sigma`
4. **Holes aren't filled**: Increase `hole_fill_area_threshold`
5. **Multiple objects when expecting one**: Set `preserve_largest_component=True`

### Performance Issues

If processing is too slow:
- Increase `min_object_size` to 300+
- Set `gaussian_sigma=0` to disable smoothing
- Use smaller `morphology_kernel_size` (1 or 2)
- Process at lower resolution and upsample if needed

## Examples

Run the example script to see different configurations:
```bash
python example_mask_refinement.py
```

This will create various refined masks showing different parameter settings and use cases.

## Dependencies

The refinement tools use standard scientific Python packages:
- `numpy`: Numerical operations
- `opencv-python`: Morphological operations and connected components
- `scikit-image`: Advanced image processing
- `scipy`: Scientific computing (hole filling)
- `PIL/Pillow`: Image I/O
- `matplotlib` (optional): For comparison visualizations

All dependencies are already included in your `requirements.txt`.

## Tips for Best Results

1. **Start with defaults**: The default parameters work well for most medical imaging tasks
2. **Tune based on your data**: Adjust `min_object_size` based on your typical object sizes
3. **Use adaptive thresholding**: Enable for better results with probability maps
4. **Preserve largest component**: Enable for single-organ segmentation tasks
5. **Monitor processing time**: Balance quality vs speed based on your requirements
6. **Validate results**: Always check a few examples to ensure refinement improves your masks 